System scale
Event scaledata : weight(W)   "emitted  by scale or (better) by datacleaner"
Event wasteStorageRPs:wasteStorageRPs(N)   "emitted  by datacleaner"
Dispatch arrived_RP : arrived_RP(N) "command that simulate the arrival of new RP"


Context ctxscale ip [ host= "localhost"      port= 8200 ] 
Context ctx_waste_incinerator_service ip [host="192.168.1.110" port=8125]

ExternalQActor wis context ctx_waste_incinerator_service
 
QActor scaledevice context ctxscale{
[# 
	lateinit var reader : java.io.BufferedReader
    lateinit var p : Process	
    var Weight = 0
#]	
	State s0 initial{
		println("$name | scalestart") 
	 	[#
			p       = Runtime.getRuntime().exec("python scale.py")
			reader  = java.io.BufferedReader(  java.io.InputStreamReader(p.getInputStream() ))	
		#]		
	}
	Goto readscaleData
	
	State readscaleData{
	[# 
		var data = reader.readLine()
		CommUtils.outyellow("$name with python: data = $data"   ) 
		if( data != null ){
		try{ 
			val vd = data.toFloat()
			val v  = vd.toInt()
			if( v <= 100 ){	//A first filter ...
				Weight = v				
			}else Weight = 0
		}catch(e: Exception){
				CommUtils.outred("$name readscaleDataERROR: $e "   )
		}
		}//if
		
	#]	
		if [# Weight > 0 #] { 
		    println("$name with python: data = $data"   ) color yellow
			emitlocalstream scaledata : weight($Weight)			 
		}
		//autodispatch doread : doread(1)
	}
	Goto readscaleData


}//scaledevice


QActor scaleusage context ctxscale {
	[# 
		var RPs = 0;
		var previous_RPs = 0; 
		val WRP = 50;
	#]
	State s0 initial {
		delay 1000
		subscribeTo scaledevice for scaledata		
		println("$name subscribed to scaledevice") color blue
	}
	Transition t0 whenEvent scaledata -> filter
	
	State filter {
     	onMsg(scaledata : weight(W)) {
	      	[#  
	      		W = payloadArg(0).toInt() 
	      		RPs = W/WRP
	      	#]	      	
	      	println("$name RPs=$RPs") color black	
	      	if [#RPs >= previous_RPs#]{ //verificare il margine della misura
	      		println("$name emit number of RPs in Waste Storage") color magenta
	      		[#
	      			for (i in previous_RPs..RPs) {
	      				#]
	      				forward wis -m arrived_RP:arrived_RP(1)
	      				[#
	      			}
	      		#]
	     	}
	      	[# previous_RPs = RPs; #]
     	}
	}	
	Transition t0 whenEvent scaledata -> filter
}

